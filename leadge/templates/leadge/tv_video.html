{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ video_config.titulo }}</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="theme-color" content="#0d6efd">
    <link rel="manifest" href="{% static 'manifest.tv.json' %}">
    <link rel="apple-touch-icon" href="{% static 'images/logo-spagi.png' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
            height: 100%;
            width: 100%;
        }
        #video-container {
            width: 100%;
            height: calc(100% - 80px); /* Ajuste para o rodapé */
            position: relative;
        }
        .responsive-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            /* Garante que o vídeo MP4 cubra a área */
            object-fit: cover; 
        }
        .error-message {
            color: white;
            text-align: center;
            padding-top: 50vh;
            transform: translateY(-50%);
            font-family: sans-serif;
        }
        
        /* --- RODAPÉ --- */
        #footer-tv {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 80px;
            background-color: rgba(0, 0, 0, 0.8); /* Fundo mais escuro */
            color: white;
            /* Alterado para usar grid ou flexbox com espaçamento */
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; /* Três colunas: Esquerda, Centro, Direita */
            align-items: center;
            padding: 0 20px;
            font-family: sans-serif;
            z-index: 1000;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.5);
        }
        .info-box {
            display: flex;
            align-items: center;
            font-size: 1.2rem;
        }
        .info-box.time-weather-group {
            display: flex;
            flex-direction: column; 
            align-items: flex-start;
            min-width: 350px;
        }
        .clima {
            color: #0dcaf0;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        #date-time-line {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            margin-bottom: 5px;
            white-space: nowrap;
        }
        #hora-atual {
            margin-left: 10px;
            font-weight: normal;
        }
        
        /* --- CRÉDITOS CENTRALIZADOS --- */
        #credits {
            text-align: center;
            font-size: 0.9rem;
            color: #ccc;
        }
        #credits strong {
            color: #fff;
        }
        
        /* --- NOTÍCIAS (Terceira Coluna) --- */
        .noticias {
            /* Alinhado à direita do grid */
            justify-self: end;
            overflow: hidden;
            position: relative;
            height: 1.2rem;
            width: 100%; /* Ocupa todo o espaço da terceira coluna */
            text-align: right;
        }
        .noticias-scroller {
            position: absolute;
            white-space: nowrap;
            /* A animação será aplicada aqui */
        }
    </style>
</head>
<body>

    <div id="video-container">
        {% if video_config.video_mp4 and video_config.video_mp4.url %}
            <video class="responsive-video" autoplay muted loop playsinline>
                <source src="{{ video_config.video_mp4.url }}" type="video/mp4">
                Seu navegador não suporta a tag de vídeo.
            </video>
        
        {% elif video_config.video_url %}
            <iframe 
                class="responsive-video"
                src="{{ video_config.video_url }}"
                allow="autoplay; fullscreen"
                autoplay
                loop
                muted
                frameborder="0"
                allowfullscreen>
            </iframe>
        
        {% else %}
            <div class="error-message">
                <h1>⚠️ Erro de Configuração</h1>
                <p>Nenhuma URL de YouTube ou vídeo MP4 foi configurado. Por favor, peça ao Administrador para configurar no Painel Admin.</p>
                <p>A página irá recarregar automaticamente para tentar novamente.</p>
            </div>
        {% endif %}
        </div>

    <div id="footer-tv">
        <div class="info-box time-weather-group">
            <div id="date-time-line">
                <span id="dia-data"></span>
                <span id="hora-atual"></span>
            </div>
            <div class="clima">
                <i class="bi bi-cloud-sun-fill me-2" id="clima-icon"></i>
                <span id="clima-info">Carregando clima...</span>
            </div>
        </div>
        
        <div id="credits">
            Powered by <strong>Spagi Sistemas</strong>
        </div>
        
        <div class="noticias">
            <div class="noticias-scroller" id="noticias-scroller">
                <i class="bi bi-newspaper me-2"></i>
                <span id="news-text">Carregando notícias...</span>
            </div>
        </div>
    </div>
    
    <script>
        // --- VARIÁVEIS DO DJANGO ---
        const API_KEY_GOOGLE = "{{ GOOGLE_MAPS_API_KEY }}"; 
        const API_KEY_NEWS = "{{ NEWS_API_KEY }}";
        const MANUAL_NEWS = "{{ MANUAL_NEWS|escapejs }}";

        // Coordenadas padrão (São José dos Pinhais)
        const CIDADE = "São José dos Pinhais";
        const LATITUDE = -25.5358; 
        const LONGITUDE = -49.2046; 
        
        // Elementos HTML
        const DIA_DATA_ELEMENT = document.getElementById('dia-data');
        const HORA_ELEMENT = document.getElementById('hora-atual');
        const CLIMA_ELEMENT = document.getElementById('clima-info');
        const CLIMA_ICON_ELEMENT = document.getElementById('clima-icon');
        const NEWS_TEXT_ELEMENT = document.getElementById('news-text');
        const NEWS_SCROLLER = document.getElementById('noticias-scroller');

        // --- LÓGICA DA HORA E DATA ---
        function updateTime() {
            const now = new Date();
            
            // Opções para Hora
            const timeOptions = { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: false
            };
            // Opções para Data (Dia da semana, dia, mês)
            const dateOptions = {
                weekday: 'long', 
                day: 'numeric', 
                month: 'long'
            };

            const formattedTime = now.toLocaleTimeString('pt-BR', timeOptions);
            
            // Formata e Capitaliza a primeira letra do dia da semana e do mês
            const formattedDateRaw = now.toLocaleDateString('pt-BR', dateOptions);
            const formattedDate = formattedDateRaw.charAt(0).toUpperCase() + formattedDateRaw.slice(1);
            
            DIA_DATA_ELEMENT.textContent = formattedDate + ",";
            HORA_ELEMENT.textContent = formattedTime;
        }
        setInterval(updateTime, 1000); // Atualiza a cada segundo
        updateTime(); // Chama imediatamente para evitar atraso inicial


        // --- LÓGICA DO CLIMA (GOOGLE WEATHER) ---
        function getWeatherTranslation(conditionCode) {
            const translations = {
                'CLEAR': 'Céu Limpo',
                'MOSTLY_CLEAR': 'Quase Limpo',
                'PARTLY_CLOUDY': 'Parcialmente Nublado',
                'MOSTLY_CLOUDY': 'Predominantemente Nublado',
                'CLOUDY': 'Nublado',
                'OVERCAST': 'Encoberto',
                'RAIN': 'Chuva',
                'SNOW': 'Neve',
                'THUNDERSTORM': 'Tempestade',
                'FOG': 'Nevoeiro',
                'WINDY': 'Ventania',
                'HAZE': 'Névoa',
                'SMOKE': 'Fumaça',
            };
            return translations[conditionCode] || conditionCode;
        }

        function getWeatherIconClass(conditionCode) {
            const iconMap = {
                'CLEAR': 'bi-sun-fill',
                'MOSTLY_CLEAR': 'bi-sun-fill',
                'PARTLY_CLOUDY': 'bi-cloud-sun-fill',
                'MOSTLY_CLOUDY': 'bi-cloud-fill',
                'CLOUDY': 'bi-cloud-fill',
                'OVERCAST': 'bi-cloud-fill',
                'RAIN': 'bi-cloud-rain-fill',
                'SNOW': 'bi-cloud-snow-fill',
                'THUNDERSTORM': 'bi-cloud-lightning-fill',
                'FOG': 'bi-cloud-haze2-fill',
                'WINDY': 'bi-wind',
            };
            return iconMap[conditionCode] || 'bi-cloud-sun-fill';
        }


        async function fetchWeather() {
            if (!API_KEY_GOOGLE || API_KEY_GOOGLE.trim() === '') {
                CLIMA_ELEMENT.textContent = `${CIDADE}: Erro - API Key não configurada.`;
                CLIMA_ICON_ELEMENT.className = 'bi bi-exclamation-triangle-fill me-2';
                return;
            }

            const weatherUrl = `https://weather.googleapis.com/v1/currentConditions:lookup?key=${API_KEY_GOOGLE}&location.latitude=${LATITUDE}&location.longitude=${LONGITUDE}`;
            
            try {
                const response = await fetch(weatherUrl, {
                    method: 'GET',
                    headers: {
                        'X-Goog-Api-Key': API_KEY_GOOGLE, 
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.status === 404) {
                    CLIMA_ELEMENT.textContent = `${CIDADE}: Erro 404. Verifique se a API Weather está habilitada.`;
                    CLIMA_ICON_ELEMENT.className = 'bi bi-exclamation-octagon-fill me-2';
                    return;
                }
                if (!response.ok) {
                    const errorData = await response.json();
                    CLIMA_ELEMENT.textContent = `${CIDADE}: Erro API ${response.status}.`;
                    CLIMA_ICON_ELEMENT.className = 'bi bi-x-circle-fill me-2';
                    console.error("Erro na resposta da API Google Weather:", errorData);
                    return; 
                }

                const data = await response.json();
                
                if (data.temperature && data.weatherCondition) {
                    const temp = Math.round(data.temperature.degrees); 
                    const conditionCode = data.weatherCondition.type; 
                    const conditionTranslated = getWeatherTranslation(conditionCode);
                    
                    CLIMA_ELEMENT.textContent = `${CIDADE}: ${temp}°C, ${conditionTranslated}`; 
                    CLIMA_ICON_ELEMENT.className = `bi ${getWeatherIconClass(conditionCode)} me-2`; 
                } else {
                    CLIMA_ELEMENT.textContent = `${CIDADE}: Dados climáticos incompletos.`;
                    CLIMA_ICON_ELEMENT.className = 'bi bi-info-circle-fill me-2';
                }

            } catch (error) {
                console.error("Erro de rede/API ao carregar o clima:", error);
                CLIMA_ELEMENT.textContent = `${CIDADE}: Erro de rede/API.`;
                CLIMA_ICON_ELEMENT.className = 'bi bi-wifi-off me-2';
            }
        }

        // --- LÓGICA DE NOTÍCIAS (Newsdata.io) e SCROLLER ---

        function startNewsScroller() {
            const newsContainer = NEWS_SCROLLER.parentElement;
            
            // 1. Reset width for correct measurement and force reflow
            NEWS_SCROLLER.style.width = 'max-content';
            NEWS_SCROLLER.style.animation = 'none';
            void NEWS_SCROLLER.offsetWidth;

            const textWidth = NEWS_SCROLLER.scrollWidth;
            const containerWidth = newsContainer.clientWidth;
            
            if (textWidth > containerWidth) {
                // 2. Cálculo da duração (70 pixels por segundo para velocidade constante)
                const totalDistance = textWidth + containerWidth;
                const duration = totalDistance / 70;
                
                const style = document.createElement('style');
                document.head.appendChild(style);
                const sheet = style.sheet;
                const animationName = 'moveText-' + Date.now(); 

                // 3. Limpa keyframes dinâmicos anteriores
                for (let i = 0; i < document.styleSheets.length; i++) {
                    try {
                        const sheet = document.styleSheets[i];
                        for (let j = 0; j < sheet.cssRules.length; j++) {
                            if (sheet.cssRules[j].name && sheet.cssRules[j].name.startsWith('moveText-')) {
                                sheet.deleteRule(j);
                            }
                        }
                    } catch(e) { /* ignora erros de segurança em folhas externas */ }
                }

                // 4. Cria a nova regra de keyframe
                sheet.insertRule(`
                    @keyframes ${animationName} {
                        0% { transform: translateX(${containerWidth}px); } /* Começa na borda direita do container */
                        100% { transform: translateX(-${textWidth}px); } /* Termina quando o texto sai da borda esquerda */
                    }
                `, 0);

                // 5. Aplica a animação
                NEWS_SCROLLER.style.width = `${textWidth}px`; 
                NEWS_SCROLLER.style.animation = `${animationName} ${duration}s linear infinite`;
                NEWS_SCROLLER.style.position = 'absolute';
            } else {
                // Texto cabe, desliga a animação
                NEWS_SCROLLER.style.position = 'static';
                NEWS_SCROLLER.style.width = 'auto';
                NEWS_SCROLLER.style.textAlign = 'center';
            }
        }

        async function fetchNews() {
            if (MANUAL_NEWS && MANUAL_NEWS.trim() !== 'None' && MANUAL_NEWS.trim() !== '') {
                // 1. PRIORIDADE: NOTÍCIAS MANUAIS
                NEWS_TEXT_ELEMENT.textContent = MANUAL_NEWS.replace(/None/g, '').trim();
                startNewsScroller();
                return;
            }

            if (!API_KEY_NEWS || API_KEY_NEWS.trim() === '') {
                NEWS_TEXT_ELEMENT.textContent = "Erro: API Key Newsdata.io não configurada. Use o campo manual.";
                return;
            }

            const newsUrl = `https://newsdata.io/api/1/latest?apikey=${API_KEY_NEWS}&q=rpc&language=pt&country=br`;
            
            try {
                const response = await fetch(newsUrl);
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    const headlines = data.results.slice(0, 10).map(item => `📰 ${item.title}`).join(' | ');
                    NEWS_TEXT_ELEMENT.textContent = headlines;
                } else {
                    NEWS_TEXT_ELEMENT.textContent = "Nenhuma notícia do G1 encontrada. Verifique a chave da API ou insira um ticker manual.";
                }

            } catch (error) {
                console.error("Erro na API Newsdata.io:", error);
                NEWS_TEXT_ELEMENT.textContent = "Erro de rede/API ao carregar notícias.";
            }

            // 3. Inicia o scroller após carregar as notícias
            startNewsScroller();
        }

        // --- LÓGICA DE RECARGA DE 24H ---
        const VIDEO_URL = "{{ video_config.video_url|escapejs }}";
        const LAST_UPDATED_STR = "{{ video_config.last_updated|date:'U' }}";
        const CHECK_INTERVAL_MS = 60000;
        const REFRESH_THRESHOLD_MS = 24 * 60 * 60 * 1000;
        let lastUpdatedTimestamp = parseInt(LAST_UPDATED_STR) * 1000;

        if (Date.now() < lastUpdatedTimestamp || isNaN(lastUpdatedTimestamp)) {
             lastUpdatedTimestamp = Date.now();
        }

        function checkRefreshNeeded() {
            const currentTime = Date.now();
            if ((currentTime - lastUpdatedTimestamp) >= REFRESH_THRESHOLD_MS) {
                console.log("Limite de 24 horas excedido. Recarregando a página.");
                window.location.reload(true); 
                return;
            }
        }
        
        // Inicia a busca do clima e notícias (o clima a cada 1h, notícias a cada 10 min)
        fetchWeather();
        fetchNews();
        setInterval(fetchWeather, 10800000); 
        setInterval(fetchNews, 10800000); // 10 minutos (600000 ms)
        setInterval(checkRefreshNeeded, CHECK_INTERVAL_MS);
        
        console.log("Player de TV Inicializado. Clima, notícias e auto-refresh ativos.");
    </script>
    <script>
     if ("serviceWorker" in navigator) {
         navigator.serviceWorker.register("{% static 'images/js/serviceworker.js' %}")
             .then(function (registration) {
                 console.log("Service Worker registrado com sucesso (TV):", registration);
                 
                // --- NOVO: Registrar Periodic Sync ---
                if ('periodicSync' in registration) {
                    requestPeriodicSyncPermission(registration);
                }
                // --- FIM NOVO ---
                 
             })
             .catch(function (error) {
                 console.log("Falha ao registrar Service Worker (TV):", error);
             });
     }
     
    // --- NOVO: Função para pedir permissão e registrar o sync (copiado do base.html) ---
    async function requestPeriodicSyncPermission(registration) {
        try {
            const status = await navigator.permissions.query({name: 'periodic-background-sync'});
            if (status.state === 'granted') {
                await registerPeriodicSync(registration);
            } else {
                console.log('Permissão para Periodic Sync não está "granted". Estado: ' + status.state);
            }
        } catch (error) {
            console.error('Falha ao verificar permissão de Periodic Sync:', error);
        }
    }

    async function registerPeriodicSync(registration) {
        try {
            await registration.periodicSync.unregister('update-cache-daily');
            await registration.periodicSync.register('update-cache-daily', {
                minInterval: 24 * 60 * 60 * 1000, // 1 dia
            });
            console.log('Periodic Sync (update-cache-daily) registrado com sucesso.');
        } catch (error) {
            console.error('Falha ao registrar Periodic Sync:', error);
        }
    }
 </script>
</body>
</html>