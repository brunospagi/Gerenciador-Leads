{% extends 'base.html' %}

{% block content %}
<style>
    .details-card .card-header {
        background-color: #e9ecef;
        font-weight: 500;
    }
    .details-list-group .list-group-item {
        border: none;
        padding: .75rem 0;
        display: flex;
        align-items: center;
    }
    .details-list-group .list-group-item i {
        color: #6c757d;
        margin-right: 12px;
        width: 20px;
        text-align: center;
    }
    .history-card .alert {
        border-left: 4px solid #0d6efd;
    }
    .priority-badge {
        font-size: 1.1rem;
        padding: .5em .8em;
    }

    /* --- NOVO: Estilos de Impressão --- */
    @media print {
        /* Esconde tudo por padrão */
        body * {
            visibility: hidden;
        }
        /* Mostra a área de impressão e seus filhos */
        .printable-area, .printable-area * {
            visibility: visible;
        }
        /* Posiciona a área de impressão */
        .printable-area {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            padding: 0;
            margin: 0;
        }
        .no-print {
            display: none !important;
        }
        /* Esconde os botões dentro do header da área de impressão */
        .printable-area .card-header div {
            display: none !important;
        }
    }
    /* --- FIM NOVO --- */
</style>

<div class="row">
    <div class="col-lg-8">
        <div class="card shadow-sm mb-4 printable-area">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="bi bi-person-vcard me-2"></i>{{ cliente.nome_cliente }}</h4>
                <div class="no-print">
                    <button onclick="window.print()" class="btn btn-info btn-sm"><i class="bi bi-printer-fill me-1"></i> Imprimir</button>
                    
                    {# --- NOVO BOTÃO DE REDISTRIBUIÇÃO --- #}
                    {% if user.is_superuser or user.profile.nivel_acesso in 'ADMIN,GERENTE,DISTRIBUIDOR' %}
                    <a href="{% url 'redistribuir-lead' cliente.pk %}" class="btn btn-outline-warning btn-sm text-white" title="Passar para outro vendedor (Rodízio)">
                        <i class="bi bi-arrow-repeat me-1"></i> Redistribuir
                    </a>
                    {% endif %}
                    {# --- FIM NOVO BOTÃO --- #}

                    <a href="{% url 'cliente_update' cliente.pk %}" class="btn btn-warning btn-sm"><i class="bi bi-pencil-square me-1"></i> Editar</a>
                    {% if user.is_superuser %}
                        <a href="{% url 'cliente_delete' cliente.pk %}" class="btn btn-danger btn-sm"><i class="bi bi-trash me-1"></i> Excluir</a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card h-100 details-card">
                            <div class="card-header">Dados do Contato</div>
                            <ul class="list-group list-group-flush details-list-group p-3">
                                <li class="list-group-item"><i class="bi bi-whatsapp"></i> <strong>WhatsApp:</strong> {{ cliente.whatsapp }}</li>
                                <li class="list-group-item"><i class="bi bi-person-video3"></i> <strong>Vendedor:</strong> {{ cliente.vendedor.username|default:"N/A" }}</li>
                                <li class="list-group-item"><i class="bi bi-person-check"></i> <strong>Fonte:</strong> {{ cliente.fonte_cliente|default:"Não informado" }}</li>
                                <li class="list-group-item"><i class="bi bi-telephone-inbound"></i> <strong>Ligações:</strong> {{ cliente.quantidade_ligacoes }}</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card h-100 details-card">
                            <div class="card-header">Dados do Veículo</div>
                            <ul class="list-group list-group-flush details-list-group p-3">
                                <li class="list-group-item"><i class="bi bi-car-front-fill"></i> <strong>Veículo:</strong> {{ cliente.marca_veiculo }} {{ cliente.modelo_veiculo }}</li>
                                <li class="list-group-item"><i class="bi bi-calendar3"></i> <strong>Ano:</strong> {{ cliente.ano_veiculo }}</li>
                                <li class="list-group-item"><i class="bi bi-tag"></i> <strong>Valor Estimado:</strong> R$ {{ cliente.valor_estimado_veiculo }}</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <h5 class="mt-3"><i class="bi bi-chat-left-text-fill text-muted"></i> Observações</h5>
                <div class="p-3 bg-light rounded mt-2">
                    <p class="mb-0">{{ cliente.observacao|linebreaks|default:"Nenhuma observação cadastrada." }}</p>
                </div>
                 <a href="{% url 'cliente_list' %}" class="btn btn-secondary mt-4 no-print"><i class="bi bi-arrow-left me-1"></i> Voltar para a Lista</a>
            </div>
        </div>
        <div class="card shadow-sm history-card no-print">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Histórico de Interações</h5>
            </div>
            <div class="card-body">
                <form action="{% url 'adicionar_historico' cliente.pk %}" method="post" class="mb-4">
                    {% csrf_token %}
                    <div class="mb-2">
                        {{ historico_form.motivacao }}
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="bi bi-plus-circle me-1"></i> Adicionar Interação</button>
                </form>
                <hr>
                {% for historico in historicos %}
                    <div class="alert alert-light mb-2">
                        <small class="fw-bold text-primary">{{ historico.data_interacao|date:"d/m/Y H:i" }}</small>
                        <p class="mb-0 mt-1">{{ historico.motivacao|linebreaks }}</p>
                    </div>
                {% empty %}
                    <p class="text-center text-muted">Nenhuma interação registrada ainda.</p>
                {% endfor %}
            </div>
        </div>

    </div>

    <div class="col-lg-4 no-print">
        <div class="card shadow-sm">
             <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-graph-up-arrow me-2"></i>Status da Negociação</h5>
            </div>
            <div class="card-body text-center">
                <h6 class="text-muted">Prioridade</h6>
                <p>
                    {% if cliente.prioridade == 'Quente' %}
                        <span class="badge bg-danger priority-badge">{{ cliente.get_prioridade_display }}</span>
                    {% elif cliente.prioridade == 'Morno' %}
                        <span class="badge bg-warning text-dark priority-badge">{{ cliente.get_prioridade_display }}</span>
                    {% else %}
                        <span class="badge bg-primary priority-badge">{{ cliente.get_prioridade_display }}</span>
                    {% endif %}
                </p>
            </div>
            <ul class="list-group list-group-flush details-list-group p-3">
                <li class="list-group-item"><i class="bi bi-flag-fill"></i> <strong>Status:</strong> <span class="badge bg-info text-dark">{{ cliente.get_status_negociacao_display }}</span></li>
                <li class="list-group-item"><i class="bi bi-gear-wide-connected"></i> <strong>Tipo:</strong> <span class="badge bg-success">{{ cliente.get_tipo_negociacao_display }}</span></li>
                <li class="list-group-item"><i class="bi bi-calendar-check-fill"></i> <strong>Último Contato:</strong> {{ cliente.data_ultimo_contato|date:"d/m/Y H:i" }}</li>
                <li class="list-group-item"><i class="bi bi-calendar-event-fill"></i> <strong>Próximo Contato:</strong> {{ cliente.data_proximo_contato|date:"d/m/Y" }}</li>
            </ul>

        </div>
    </div>  
</div>
{% endblock %}