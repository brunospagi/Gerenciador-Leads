{% extends 'base.html' %}

{% block content %}
<h1>{% if form.instance.pk %}Editar Cliente{% else %}Cadastrar Novo Cliente{% endif %}</h1>
<form method="post">
    {% csrf_token %}
    
    {{ form.marca_veiculo }}
    {{ form.modelo_veiculo }}

    <h5 class="mb-3 border-bottom pb-2">1. Dados do Cliente</h5>
    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="{{ form.nome_cliente.id_for_label }}" class="form-label">{{ form.nome_cliente.label }}</label>
            {{ form.nome_cliente }}
        </div>
        <div class="col-md-6 mb-3">
            <label for="{{ form.whatsapp.id_for_label }}" class="form-label">{{ form.whatsapp.label }}</label>
            {{ form.whatsapp }}
        </div>
    </div>
    
    <h5 class="mt-4 mb-3 border-bottom pb-2">2. Dados do Veículo (Busca FIPE)</h5>
    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="marca_select" class="form-label">Marca</label>
            <select id="marca_select" class="form-select" required>
                <option value="" selected disabled>Carregando...</option>
            </select>
        </div>
        <div class="col-md-6 mb-3">
            <label for="modelo_select" class="form-label">Modelo</label>
            <select id="modelo_select" class="form-select" disabled required>
                <option value="" selected disabled>Selecione uma marca</option>
            </select>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="{{ form.valor_estimado_veiculo.id_for_label }}" class="form-label">{{ form.valor_estimado_veiculo.label }}</label>
            {{ form.valor_estimado_veiculo }}
        </div>
    </div>
    
    <h5 class="mt-4 mb-3 border-bottom pb-2">3. Detalhes da Negociação</h5>
    <div class="row">
        {% for field in form %}
            {% if field.name not in "nome_cliente,whatsapp,marca_veiculo,modelo_veiculo,valor_estimado_veiculo" %}
                <div class="col-md-6 mb-3">
                    <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}
                        <div class="text-danger">
                            {{ field.errors.as_text }}
                        </div>
                    {% endif %}
                    {% if field.name == 'vendedor' and field.disabled %}
                        <div class="form-text">Apenas administradores podem alterar o vendedor.</div>
                    {% endif %}
                </div>
            {% endif %}
        {% endfor %}
    </div>

    <div class="mt-4">
        <button type="submit" class="btn btn-success">Salvar</button>
        <a href="{% url 'cliente_list' %}" class="btn btn-secondary">Cancelar</a>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', (event) => {
    const phoneInput = document.getElementById('id_whatsapp');
    if (phoneInput) {
        IMask(phoneInput, { mask: [{ mask: '(00) 0000-0000' }, { mask: '(00) 0 0000-0000' }] });
    }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const marcaSelect = document.getElementById('marca_select');
    const modeloSelect = document.getElementById('modelo_select');
    const marcaInput = document.getElementById('id_marca_veiculo');
    const modeloInput = document.getElementById('id_modelo_veiculo');
    const marcasUrl = "{% url 'api_fipe_marcas' %}";

    const resetSelect = (select, message) => {
        select.innerHTML = `<option value="" selected disabled>${message}</option>`;
        select.disabled = true;
    };

    fetch(marcasUrl)
        .then(response => response.json())
        .then(data => {
            marcaSelect.innerHTML = '<option value="" selected disabled>Selecione uma marca</option>';
            data.forEach(marca => {
                const option = new Option(marca.nome, marca.codigo);
                if (marca.nome === marcaInput.value) {
                    option.selected = true;
                }
                marcaSelect.add(option);
            });
        }).catch(error => console.error('Erro ao carregar marcas:', error));

    marcaSelect.addEventListener('change', () => {
        const marcaId = marcaSelect.value;
        const marcaNome = marcaSelect.options[marcaSelect.selectedIndex].text;
        resetSelect(modeloSelect, 'Carregando...');
        if (!marcaId) return;
        marcaInput.value = marcaNome;
        modeloInput.value = '';
        fetch(`/api/fipe/marcas/${marcaId}/modelos/`)
            .then(response => response.json())
            .then(data => {
                modeloSelect.innerHTML = '<option value="" selected disabled>Selecione um modelo</option>';
                data.forEach(modelo => {
                    const option = new Option(modelo.nome, modelo.codigo);
                    modeloSelect.add(option);
                });
                modeloSelect.disabled = false;
            }).catch(error => console.error('Erro ao carregar modelos:', error));
    });

    modeloSelect.addEventListener('change', () => {
        const modeloNome = modeloSelect.options[modeloSelect.selectedIndex].text;
        modeloInput.value = modeloNome;
    });
});
</script>
{% endblock %}