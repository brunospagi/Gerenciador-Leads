{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if form.instance.pk %}Editar Venda{% else %}Nova Venda{% endif %}
{% endblock %}

{% block content %}
<style>
    /* Estilos Originais do seu Layout */
    .clean-card { border: none; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); margin-bottom: 24px; background: #fff; }
    .clean-header { padding: 20px 24px; border-bottom: 1px solid #f0f2f5; font-weight: 700; color: #2c3e50; display: flex; align-items: center; background: linear-gradient(to right, #ffffff, #f8f9fa); border-radius: 12px 12px 0 0; }
    .clean-header i { margin-right: 12px; color: #3498db; font-size: 1.1em; }
    .clean-body { padding: 24px; }
    .mode-selector label { transition: all 0.2s; border: 2px solid #e9ecef; }
    .mode-selector .btn-check:checked + label { border-color: #3498db; background-color: #f1f9fe; color: #2980b9; }
    .modal-item { border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 10px; transition: 0.2s; }
    .modal-item:hover { background-color: #fcfcfc; }
    .modal-item.active { border-color: #27ae60; background-color: #f0f9f4; }
</style>

<div class="container py-5" style="max-width: 1000px;">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-0">{% if form.instance.pk %}Editar Venda{% else %}Nova Venda{% endif %}</h2>
            <p class="text-muted mb-0">Preencha os dados da negociação</p>
        </div>
        <a href="{% url 'venda_produto_list' %}" class="btn btn-outline-secondary"><i class="fa fa-times me-2"></i>Cancelar</a>
    </div>

    <form method="post" enctype="multipart/form-data" id="vendaForm">
        {% csrf_token %}
        {% if form.non_field_errors %}
            <div class="alert alert-danger rounded-3 mb-4 shadow-sm">{{ form.non_field_errors }}</div>
        {% endif %}

        {% if not form.instance.pk %}
        <div class="clean-card text-center py-5 mode-selector">
            <h5 class="fw-bold text-muted mb-4 text-uppercase ls-1">Qual o tipo da operação?</h5>
            <div class="btn-group w-100 px-4" role="group" style="max-width: 700px;">
                <input type="radio" class="btn-check" name="modo_venda" id="modo_veiculo" autocomplete="off">
                <label class="btn btn-outline-light text-dark py-4 rounded-start" for="modo_veiculo">
                    <i class="fa fa-car fa-2x d-block mb-2 text-primary"></i>
                    <span class="fw-bold">VENDA DE VEÍCULO</span>
                </label>

                <input type="radio" class="btn-check" name="modo_venda" id="modo_servico" autocomplete="off" checked>
                <label class="btn btn-outline-light text-dark py-4 rounded-end" for="modo_servico">
                    <i class="fa fa-file-contract fa-2x d-block mb-2 text-secondary"></i>
                    <span class="fw-bold">SERVIÇO AVULSO</span>
                </label>
            </div>
        </div>
        {% endif %}

        <div style="display:none;">{{ form.tipo_produto }}</div>

        <div class="clean-card">
            <div class="clean-header"><i class="fa fa-user-circle"></i> Dados Gerais</div>
            <div class="clean-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label fw-bold small text-uppercase text-muted">Data</label>
                        {{ form.data_venda }}
                    </div>
                    <div class="col-md-5">
                        <label class="form-label fw-bold small text-uppercase text-muted">Cliente *</label>
                        {{ form.cliente_nome }}
                    </div>
                    
                    <div class="col-md-4" id="div-select-tipo">
                        <label class="form-label fw-bold small text-uppercase text-muted">Serviço *</label>
                        <select class="form-select" id="fake_tipo_select">
                            <option value="GARANTIA">Seguro Garantia</option>
                            <option value="SEGURO">Seguro Novo</option>
                            <option value="TRANSFERENCIA">Transferência</option>
                        </select>
                    </div>

                    <div class="col-md-4" id="label-veiculo-display" style="display:none;">
                        <label class="form-label fw-bold small text-uppercase text-muted">Operação</label>
                        <div class="form-control bg-light fw-bold text-primary border-0">Venda de Veículo</div>
                    </div>
                </div>

                <div id="row-veiculo-details" class="mt-4 pt-3 border-top">
                    <h6 class="text-primary small fw-bold mb-3"><i class="fa fa-car me-1"></i> Dados do Veículo</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold small text-uppercase text-muted">Modelo *</label>
                            {{ form.modelo_veiculo }}
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold small text-uppercase text-muted">Placa *</label>
                            {{ form.placa }}
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold small text-uppercase text-muted">Cor *</label>
                            {{ form.cor }}
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold small text-uppercase text-muted">Ano *</label>
                            {{ form.ano }}
                        </div>
                    </div>
                    
                    <div class="mt-3 row" id="div-desconto-container" style="display:none;">
                        <div class="col-md-4">
                            <label class="form-label fw-bold small text-uppercase text-danger">Deu Desconto?</label>
                            {{ form.com_desconto }}
                            <div class="form-text small text-muted">Se Sim, a comissão será fixa em R$ 200.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="div-btn-modal" class="mb-4" style="display:none;">
            <button type="button" class="btn btn-outline-success w-100 py-3 fw-bold border-2 border-dashed" data-bs-toggle="modal" data-bs-target="#modalAdicionais">
                <i class="fa fa-plus-circle me-2"></i> INCLUIR SERVIÇOS EXTRAS (VENDA CASADA)
                <span id="badge-adicionais" class="badge bg-success ms-2 rounded-pill" style="display:none;">0</span>
            </button>
        </div>

        <div class="clean-card">
            <div class="clean-header bg-primary text-white" style="background: #3498db;">
                <i class="fa fa-wallet text-white"></i> 
                <span id="label-financeiro-main">Pagamento</span>
            </div>
            <div class="clean-body bg-light-subtle">
                <div class="row align-items-center mb-4">
                    <div class="col-md-3">
                        <label class="form-label fw-bold text-success fs-5">Valor Total (R$)</label>
                        {{ form.valor_venda }}
                    </div>
                    
                    <div class="col-md-3" id="div-custo-base" style="display:none;">
                        <label class="form-label fw-bold text-danger fs-5">Custo Despachante</label>
                        {{ form.custo_base }}
                    </div>

                    <div class="col-md-6 text-end">
                        <span id="feedback-pagamento" class="badge bg-secondary p-2">Preencha os valores</span>
                    </div>
                </div>

                <div class="row g-2">
                    <div class="col-md-2 col-6"><label class="small fw-bold text-muted">Pix</label>{{ form.pgto_pix }}</div>
                    <div class="col-md-2 col-6"><label class="small fw-bold text-muted">Transf.</label>{{ form.pgto_transferencia }}</div>
                    <div class="col-md-2 col-6"><label class="small fw-bold text-muted">Débito</label>{{ form.pgto_debito }}</div>
                    <div class="col-md-2 col-6"><label class="small fw-bold text-muted">Crédito</label>{{ form.pgto_credito }}</div>
                    <div class="col-md-4 col-12"><label class="small fw-bold text-muted">Financiamento</label>{{ form.pgto_financiamento }}</div>
                </div>

                <div id="div-financiamento" class="mt-3 p-3 bg-white rounded border" style="display:none;">
                    <div class="row g-2">
                        <div class="col-md-6"><label class="small fw-bold">Banco</label>{{ form.banco_financiamento }}</div>
                        <div class="col-md-6"><label class="small fw-bold">Proposta</label>{{ form.numero_proposta }}</div>
                    </div>
                </div>

                <div id="div-comprovante" class="mt-3" style="display:none;">
                    <label class="small fw-bold">Comprovante</label>
                    {{ form.comprovante }}
                </div>
            </div>
        </div>

        <div class="mb-5">
            <label class="form-label fw-bold small text-muted">Observações</label>
            {{ form.observacoes }}
        </div>

        <div class="d-grid">
            <button type="submit" class="btn btn-primary btn-lg fw-bold shadow-sm">SALVAR VENDA</button>
        </div>

        <div class="modal fade" id="modalAdicionais" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content border-0">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title fw-bold"><i class="fa fa-cart-plus me-2"></i> Serviços Adicionais</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body bg-light">
                        <p class="text-muted text-center mb-4 small">Informe o valor e como cada serviço extra foi pago.</p>
                        
                        <div class="modal-item">
                            <div class="form-check mb-2">
                                {{ form.adicional_garantia }}
                                <label class="form-check-label fw-bold" for="{{ form.adicional_garantia.id_for_label }}">Garantia Mecânica</label>
                            </div>
                            <div class="row g-2 ps-4 inputs-wrapper" style="display:none;">
                                <div class="col-6"><label class="small fw-bold">Valor</label>{{ form.valor_garantia }}</div>
                                <div class="col-6"><label class="small fw-bold">Pagamento</label>{{ form.metodo_garantia }}</div>
                            </div>
                        </div>

                        <div class="modal-item">
                            <div class="form-check mb-2">
                                {{ form.adicional_seguro }}
                                <label class="form-check-label fw-bold" for="{{ form.adicional_seguro.id_for_label }}">Seguro Novo</label>
                            </div>
                            <div class="row g-2 ps-4 inputs-wrapper" style="display:none;">
                                <div class="col-6"><label class="small fw-bold">Valor</label>{{ form.valor_seguro }}</div>
                                <div class="col-6"><label class="small fw-bold">Pagamento</label>{{ form.metodo_seguro }}</div>
                            </div>
                        </div>

                        <div class="modal-item">
                            <div class="form-check mb-2">
                                {{ form.adicional_transferencia }}
                                <label class="form-check-label fw-bold" for="{{ form.adicional_transferencia.id_for_label }}">Transferência</label>
                            </div>
                            <div class="row g-2 ps-4 inputs-wrapper" style="display:none;">
                                <div class="col-4"><label class="small fw-bold">Valor</label>{{ form.valor_transferencia }}</div>
                                <div class="col-4"><label class="small fw-bold text-danger">Custo</label>{{ form.custo_transferencia }}</div>
                                <div class="col-4"><label class="small fw-bold">Pagamento</label>{{ form.metodo_transferencia }}</div>
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer bg-light border-0">
                        <button type="button" class="btn btn-success w-100 fw-bold" data-bs-dismiss="modal">Confirmar</button>
                    </div>
                </div>
            </div>
        </div>

    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modoVeiculoBtn = document.getElementById('modo_veiculo');
    const modoServicoBtn = document.getElementById('modo_servico');
    const realTipoSelect = document.getElementById('id_tipo_produto');
    const fakeTipoSelect = document.getElementById('fake_tipo_select');
    
    // Areas Visuais
    const rowVeiculo = document.getElementById('row-veiculo-details');
    const divSelectTipo = document.getElementById('div-select-tipo');
    const labelVeiculoDisplay = document.getElementById('label-veiculo-display');
    const divBtnModal = document.getElementById('div-btn-modal');
    const divDescontoContainer = document.getElementById('div-desconto-container');
    const labelFinanceiro = document.getElementById('label-financeiro-main');
    
    // Custo Base
    const divCustoBase = document.getElementById('div-custo-base');
    
    // Inputs Obrigatórios
    const inputModelo = document.getElementById('id_modelo_veiculo');
    const inputPlaca = document.getElementById('id_placa');
    const inputCor = document.getElementById('id_cor');
    const inputAno = document.getElementById('id_ano');

    // Financeiro
    const inputValorMain = document.getElementById('id_valor_venda');
    const inputsPgtoCarro = document.querySelectorAll('.payment-input');
    const feedbackPgto = document.getElementById('feedback-pagamento');
    const inputFinan = document.getElementById('id_pgto_financiamento');
    const divFinan = document.getElementById('div-financiamento');
    const divComp = document.getElementById('div-comprovante');

    function checkCustoVisibility(isVeiculo, tipo) {
        // Mostra custo apenas se for Serviço Avulso DE Transferência
        if (!isVeiculo && tipo === 'TRANSFERENCIA') {
            divCustoBase.style.display = 'block';
        } else {
            divCustoBase.style.display = 'none';
        }
    }

    function updateMode() {
        let isVeiculo = false;
        if (modoVeiculoBtn && modoVeiculoBtn.checked) isVeiculo = true;
        else if (!modoVeiculoBtn && realTipoSelect.value === 'VENDA_VEICULO') isVeiculo = true;

        rowVeiculo.style.display = 'block';
        
        inputModelo.required = true;
        inputPlaca.required = true;
        inputCor.required = true;
        inputAno.required = true;

        if (isVeiculo) {
            realTipoSelect.value = 'VENDA_VEICULO';
            divSelectTipo.style.display = 'none';
            labelVeiculoDisplay.style.display = 'block';
            
            divBtnModal.style.display = 'block'; 
            divDescontoContainer.style.display = 'flex'; 
            labelFinanceiro.innerText = "Pagamento do Veículo";
            
            checkCustoVisibility(true, 'VENDA_VEICULO');
        } else {
            realTipoSelect.value = fakeTipoSelect.value;
            divSelectTipo.style.display = 'block';
            labelVeiculoDisplay.style.display = 'none';
            
            divBtnModal.style.display = 'none'; 
            divDescontoContainer.style.display = 'none';
            labelFinanceiro.innerText = "Pagamento do Serviço";
            
            checkCustoVisibility(false, fakeTipoSelect.value);
            updateModalUI(true); 
        }
    }

    fakeTipoSelect.addEventListener('change', function() { 
        realTipoSelect.value = this.value; 
        checkCustoVisibility(false, this.value);
    });

    if(modoVeiculoBtn) {
        modoVeiculoBtn.addEventListener('change', updateMode);
        modoServicoBtn.addEventListener('change', updateMode);
    }

    // Modal UI
    const badgeAdicionais = document.getElementById('badge-adicionais');
    const items = [
        { check: 'id_adicional_garantia', val: 'id_valor_garantia', met: 'id_metodo_garantia' },
        { check: 'id_adicional_seguro', val: 'id_valor_seguro', met: 'id_metodo_seguro' },
        { check: 'id_adicional_transferencia', val: 'id_valor_transferencia', met: 'id_metodo_transferencia' }
    ];

    function updateModalUI(reset = false) {
        let count = 0;
        items.forEach(item => {
            const chk = document.getElementById(item.check);
            if (reset && chk) chk.checked = false;
            
            const val = document.getElementById(item.val);
            const met = document.getElementById(item.met);
            const wrapper = val.closest('.inputs-wrapper');
            const card = chk.closest('.modal-item');

            if (chk.checked) {
                wrapper.style.display = 'flex';
                val.required = true;
                met.required = true;
                card.classList.add('active');
                count++;
            } else {
                wrapper.style.display = 'none';
                val.required = false;
                met.required = false;
                val.value = '';
                met.value = '';
                card.classList.remove('active');
            }
        });
        badgeAdicionais.style.display = count > 0 ? 'inline-block' : 'none';
        badgeAdicionais.innerText = count;
    }
    
    items.forEach(item => document.getElementById(item.check).addEventListener('change', () => updateModalUI(false)));

    function updateFinanceiro() {
        let total = parseFloat(inputValorMain.value) || 0;
        let pago = 0;
        let temImediato = false;
        inputsPgtoCarro.forEach(inp => {
            let v = parseFloat(inp.value) || 0;
            pago += v;
            if (v > 0 && (inp.id.includes('pix') || inp.id.includes('transferencia'))) temImediato = true;
        });

        let diff = total - pago;
        if (total > 0 && Math.abs(diff) < 0.05) {
            feedbackPgto.className = 'badge bg-success p-2';
            feedbackPgto.innerHTML = '<i class="fa fa-check"></i> OK';
        } else {
            feedbackPgto.className = 'badge bg-danger p-2';
            feedbackPgto.innerText = diff > 0 ? `Falta R$ ${diff.toFixed(2)}` : `Passou R$ ${Math.abs(diff).toFixed(2)}`;
        }

        if ((parseFloat(inputFinan.value) || 0) > 0) {
            divFinan.style.display = 'block';
            document.getElementById('id_banco_financiamento').required = true;
        } else {
            divFinan.style.display = 'none';
            document.getElementById('id_banco_financiamento').required = false;
        }
        divComp.style.display = temImediato ? 'block' : 'none';
    }

    inputValorMain.addEventListener('input', updateFinanceiro);
    inputsPgtoCarro.forEach(inp => inp.addEventListener('input', updateFinanceiro));

    // Inicialização
    updateMode();
    updateModalUI();
    updateFinanceiro();
});
</script>
{% endblock %}