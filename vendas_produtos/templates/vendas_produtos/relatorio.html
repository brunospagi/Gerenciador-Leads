{% extends 'base.html' %}
{% load static %}

{% block title %}Relatório de Comissões{% endblock %}

{% block content %}
<style>
    /* Estilos para visualização em tela */
    .card-dashboard {
        transition: transform 0.2s;
        border: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .card-dashboard:hover {
        transform: translateY(-5px);
    }

    /* Estilos exclusivos para impressão (PDF) */
    @media print {
        @page { size: A4; margin: 10mm; }
        body { 
            background-color: white !important; 
            font-family: sans-serif; 
            -webkit-print-color-adjust: exact !important; 
            print-color-adjust: exact !important; 
        }
        
        /* Oculta menus, botões e barras laterais */
        .d-print-none, header, footer, nav, .sidebar, .navbar, .btn { 
            display: none !important; 
        }
        
        /* Ajusta largura para 100% da folha */
        .container, .container-fluid { 
            width: 100% !important; 
            max-width: 100% !important; 
            padding: 0 !important; 
            margin: 0 !important; 
        }
        
        .print-sheet { 
            box-shadow: none !important; 
            padding: 0 !important; 
            border: none !important; 
        }
        
        .card-dashboard { 
            box-shadow: none !important; 
            border: 1px solid #ccc !important; 
        }
        
        /* Evita quebras de página ruins */
        .break-inside-avoid { 
            break-inside: avoid; 
            page-break-inside: avoid; 
        }
        
        /* Força cores de fundo */
        .bg-dark { background-color: #343a40 !important; color: white !important; }
        .bg-warning { background-color: #ffc107 !important; color: black !important; }
        .bg-light { background-color: #f8f9fa !important; }
        
        /* Ajuste fino de fontes */
        .fs-4 { font-size: 1.2rem !important; }
        table { font-size: 0.8rem !important; }
    }
</style>

<div class="container-fluid py-4" style="background-color: #f8f9fc; min-height: 100vh;">
    
    <div class="card mb-4 d-print-none shadow-sm mx-auto border-0" style="max-width: 1200px;">
        <div class="card-body d-flex flex-wrap justify-content-between align-items-center gap-3">
            <div>
                <h5 class="mb-0 fw-bold text-gray-800"><i class="fa fa-file-invoice-dollar me-2 text-primary"></i>Relatório Financeiro</h5>
            </div>
            
            <form method="get" class="d-flex align-items-center gap-2 flex-grow-1 justify-content-end">
                <input type="hidden" name="data_inicio" value="{{ periodo_inicio_str }}">
                <input type="hidden" name="data_fim" value="{{ periodo_fim_str }}">
                
                <div class="input-group input-group-sm" style="max-width: 300px;">
                    <span class="input-group-text bg-white"><i class="fa fa-filter"></i></span>
                    <select name="vendedor" class="form-select" onchange="this.form.submit()">
                        <option value="">Todos os Vendedores</option>
                        {% for v in lista_vendedores %}
                        <option value="{{ v.id }}" {% if vendedor_selecionado == v.id %}selected{% endif %}>
                            {{ v.get_full_name|default:v.username }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% if vendedor_selecionado %}
                    <a href="?data_inicio={{ periodo_inicio_str }}&data_fim={{ periodo_fim_str }}" class="btn btn-outline-danger btn-sm" title="Limpar Filtro"><i class="fa fa-times"></i></a>
                {% endif %}
            </form>

            <button onclick="window.print()" class="btn btn-primary btn-sm px-4 fw-bold">
                <i class="fa fa-print me-2"></i> Imprimir / Salvar PDF
            </button>
        </div>
    </div>

    <div id="pdf-content" class="print-sheet mx-auto bg-white shadow-lg p-5 rounded" style="max-width: 1200px;">
        
        <div class="d-flex justify-content-between align-items-end border-bottom pb-3 mb-4">
            <div>
                <h2 class="fw-bold text-dark mb-0">SPAGI <span class="text-primary">Sistemas</span></h2>
                <div class="text-uppercase fw-bold mt-2 text-secondary small" style="letter-spacing: 1px;">Relatório Analítico de Vendas</div>
            </div>
            <div class="text-end">
                <div class="fs-5 fw-bold text-dark">{{ periodo_inicio|date:"d/m/Y" }} <span class="text-muted small">até</span> {{ periodo_fim|date:"d/m/Y" }}</div>
                <div class="small text-muted mt-1">Gerado em: {% now "d/m/Y H:i" %}</div>
            </div>
        </div>

        <div class="row mb-5 g-3">
            <div class="col-6 col-md-3">
                <div class="p-3 rounded border card-dashboard bg-white text-center h-100 d-flex flex-column justify-content-center">
                    <small class="text-uppercase fw-bold text-muted mb-1" style="font-size: 0.7rem;">Qtd. Vendas</small>
                    <div class="fs-3 fw-bold text-secondary">{{ qtd_vendas }}</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="p-3 rounded border card-dashboard bg-white text-center h-100 d-flex flex-column justify-content-center">
                    <small class="text-uppercase fw-bold text-info mb-1" style="font-size: 0.7rem;">Valor Bruto (Total)</small>
                    <div class="fs-3 fw-bold text-dark">R$ {{ total_geral_bruto|floatformat:2 }}</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="p-3 rounded border card-dashboard bg-white text-center h-100 d-flex flex-column justify-content-center">
                    <small class="text-uppercase fw-bold text-primary mb-1" style="font-size: 0.7rem;">Lucro Loja (Est.)</small>
                    <div class="fs-3 fw-bold text-primary">R$ {{ total_geral_loja|floatformat:2 }}</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="p-3 rounded border card-dashboard bg-white text-center h-100 d-flex flex-column justify-content-center">
                    <small class="text-uppercase fw-bold text-success mb-1" style="font-size: 0.7rem;">Total Comissões</small>
                    <div class="fs-3 fw-bold text-success">R$ {{ total_geral_comissao|floatformat:2 }}</div>
                </div>
            </div>
        </div>

        {% if relatorio_vendedores %}
            {% for item in relatorio_vendedores %}
            <div class="mb-5 break-inside-avoid">
                <div class="d-flex justify-content-between align-items-center bg-dark text-white p-2 px-3 rounded-top shadow-sm">
                    <div class="fw-bold fs-6 d-flex align-items-center">
                        <i class="fa fa-user me-2 opacity-75"></i> 
                        {{ item.vendedor.get_full_name|default:item.vendedor.username|upper }}
                    </div>
                    <div class="bg-warning text-dark px-3 py-1 rounded-pill fw-bold shadow-sm" style="font-size: 0.85rem;">
                        Comissão: R$ {{ item.total_comissao|floatformat:2 }}
                    </div>
                </div>
                
                <div class="table-responsive border border-top-0 rounded-bottom">
                    <table class="table table-striped table-hover mb-0" style="font-size: 0.85rem;">
                        <thead class="bg-light text-secondary text-uppercase small">
                            <tr>
                                <th class="py-2 ps-3" style="width: 10%;">Data</th>
                                <th class="py-2">Veículo / Produto</th>
                                <th class="py-2">Cliente</th>
                                <th class="py-2">Pagamento</th> 
                                <th class="text-end py-2" style="width: 15%;">Valor Venda</th>
                                <th class="text-end py-2 pe-3" style="width: 15%;">Comissão</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for venda in item.vendas %}
                            <tr>
                                <td class="ps-3 align-middle">{{ venda.data_venda|date:"d/m" }}</td>
                                <td class="align-middle">
                                    <div class="fw-bold text-dark">{{ venda.get_tipo_produto_display }}</div>
                                    {% if venda.modelo_veiculo %}
                                        <small class="text-muted d-block mt-0">
                                            {{ venda.modelo_veiculo }} <span class="fw-bold ms-1">{{ venda.placa }}</span>
                                        </small>
                                    {% endif %}
                                    {% if venda.com_desconto %}
                                        <span class="badge bg-danger mt-1" style="font-size: 0.6rem;">COM DESCONTO</span>
                                    {% endif %}
                                </td>
                                <td class="align-middle">{{ venda.cliente_nome|truncatechars:25 }}</td>
                                <td class="small align-middle text-muted">{{ venda.resumo_pagamento }}</td> 
                                <td class="text-end align-middle">R$ {{ venda.valor_venda|floatformat:2 }}</td>
                                <td class="text-end align-middle fw-bold text-success pe-3">R$ {{ venda.comissao_vendedor|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="bg-white">
                            <tr>
                                <td colspan="6" class="text-end py-1 pe-3 text-muted small fst-italic">
                                    Itens listados: {{ item.vendas|length }}
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-light text-center p-5 border shadow-sm">
                <h4 class="text-muted fw-light">Nenhum registro encontrado.</h4>
                <p class="mb-0 text-muted small">Não há vendas para o período ou filtro selecionado.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}