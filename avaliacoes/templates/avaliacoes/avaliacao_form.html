{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card shadow-sm">
            <div class="card-header bg-dark text-white">
                <h4 class="mb-0">
                    {% if form.instance.pk %}
                        <i class="bi bi-pencil-square me-2"></i>Editar Avaliação
                    {% else %}
                        <i class="bi bi-plus-circle me-2"></i>Cadastrar Nova Avaliação
                    {% endif %}
                </h4>
            </div>
            <div class="card-body p-4">
                <form method="post" enctype="multipart/form-data" id="avaliacaoForm">
                    {% csrf_token %}
                    {{ form.marca }}
                    {{ form.modelo }}
                    {{ form.ano }}

                    <h5 class="mb-3 border-bottom pb-2"><i class="bi bi-car-front-fill me-2"></i>1. Seleção do Veículo (API FIPE)</h5>
                    <div class="row align-items-end">
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.tipo_veiculo.id_for_label }}" class="form-label">{{ form.tipo_veiculo.label }}</label>
                            {{ form.tipo_veiculo }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="marca_select" class="form-label">Marca</label>
                            <select id="marca_select" class="form-select" required>
                                <option value="" selected disabled>Selecione o tipo</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="modelo_select" class="form-label">Modelo</label>
                            <select id="modelo_select" class="form-select" disabled required>
                                <option value="" selected disabled>Selecione a marca</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="ano_select" class="form-label">Ano</label>
                            <select id="ano_select" class="form-select" disabled required>
                                <option value="" selected disabled>Selecione o modelo</option>
                            </select>
                        </div>
                    </div>

                    <h5 class="mt-4 mb-3 border-bottom pb-2"><i class="bi bi-clipboard-data-fill me-2"></i>2. Dados da Avaliação e Contato</h5>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.placa.id_for_label }}" class="form-label">{{ form.placa.label }}</label>
                            {{ form.placa }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.telefone.id_for_label }}" class="form-label">{{ form.telefone.label }}</label>
                            {{ form.telefone }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.valor_pretendido.id_for_label }}" class="form-label">{{ form.valor_pretendido.label }}</label>
                            {{ form.valor_pretendido }}
                        </div>
                    </div>
                     <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.observacao.id_for_label }}" class="form-label">{{ form.observacao.label }}</label>
                            {{ form.observacao }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.valor_avaliado.id_for_label }}" class="form-label">{{ form.valor_avaliado.label }}</label>
                            {{ form.valor_avaliado }}
                        </div>
                    </div>
                    
                    {% if not form.instance.pk %}
                    <h5 class="mt-4 mb-3 border-bottom pb-2"><i class="bi bi-images me-2"></i>3. Fotos do Veículo</h5>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="id_fotos" class="form-label">Selecione as Fotos (até 20)</label>
                            <input type="file" name="fotos" class="form-control" id="id_fotos" multiple>
                        </div>
                    </div>
                    {% endif %}

                    <div class="card-footer bg-light text-end mt-4">
                        <a href="{% url 'avaliacao_list' %}" class="btn btn-secondary"><i class="bi bi-x-circle me-1"></i>Cancelar</a>
                        <button type="submit" class="btn btn-success"><i class="bi bi-check-circle-fill me-1"></i>Salvar Avaliação</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- ADIÇÃO DAS MÁSCARAS DE VALOR ---
    const valorPretendidoInput = document.getElementById('id_valor_pretendido');
    if (valorPretendidoInput) {
        IMask(valorPretendidoInput, {
            mask: 'R$ num',
            blocks: {
                num: {
                    mask: Number,
                    scale: 2,
                    radix: ',',
                    thousandsSeparator: '.',
                    padFractionalZeros: true
                }
            }
        });
    }

    const valorAvaliadoInput = document.getElementById('id_valor_avaliado');
    if (valorAvaliadoInput) {
        IMask(valorAvaliadoInput, {
            mask: 'R$ num',
            blocks: {
                num: {
                    mask: Number,
                    scale: 2,
                    radix: ',',
                    thousandsSeparator: '.',
                    padFractionalZeros: true
                }
            }
        });
    }

    const tipoVeiculoSelect = document.getElementById('id_tipo_veiculo');
    const marcaSelect = document.getElementById('marca_select');
    const modeloSelect = document.getElementById('modelo_select');
    const anoSelect = document.getElementById('ano_select');

    const marcaInput = document.getElementById('id_marca');
    const modeloInput = document.getElementById('id_modelo');
    const anoInput = document.getElementById('id_ano');

    const resetSelect = (select, message) => {
        select.innerHTML = `<option value="" selected disabled>${message}</option>`;
        select.disabled = true;
    };

    function carregarMarcas() {
        const tipoVeiculo = tipoVeiculoSelect.value;
        if (!tipoVeiculo) return;

        resetSelect(marcaSelect, 'Carregando...');
        resetSelect(modeloSelect, 'Selecione a marca');
        resetSelect(anoSelect, 'Selecione o modelo');
        
        const marcasUrl = `/api/fipe/${tipoVeiculo}/marcas/`;

        fetch(marcasUrl)
            .then(response => response.json())
            .then(data => {
                marcaSelect.innerHTML = '<option value="" selected disabled>Selecione uma marca</option>';
                data.forEach(marca => {
                    const option = new Option(marca.nome, marca.codigo);
                    marcaSelect.add(option);
                });
                marcaSelect.disabled = false;
            })
            .catch(error => console.error('Erro ao carregar marcas:', error));
    }

    tipoVeiculoSelect.addEventListener('change', carregarMarcas);
    carregarMarcas();

    marcaSelect.addEventListener('change', () => {
        const tipoVeiculo = tipoVeiculoSelect.value;
        const marcaId = marcaSelect.value;
        const marcaNome = marcaSelect.options[marcaSelect.selectedIndex].text;
        
        resetSelect(modeloSelect, 'Carregando modelos...');
        resetSelect(anoSelect, 'Selecione um modelo');

        if (!marcaId) return;

        marcaInput.value = marcaNome;
        modeloInput.value = '';
        anoInput.value = '';

        fetch(`/api/fipe/${tipoVeiculo}/marcas/${marcaId}/modelos/`)
            .then(response => response.json())
            .then(data => {
                modeloSelect.innerHTML = '<option value="" selected disabled>Selecione um modelo</option>';
                data.forEach(modelo => {
                    const option = new Option(modelo.nome, modelo.codigo);
                    modeloSelect.add(option);
                });
                modeloSelect.disabled = false;
            })
            .catch(error => console.error('Erro ao carregar modelos:', error));
    });

    modeloSelect.addEventListener('change', () => {
        const tipoVeiculo = tipoVeiculoSelect.value;
        const marcaId = marcaSelect.value;
        const modeloId = modeloSelect.value;
        const modeloNome = modeloSelect.options[modeloSelect.selectedIndex].text;
        
        resetSelect(anoSelect, 'Carregando anos...');

        if (!modeloId) return;
        
        modeloInput.value = modeloNome;
        anoInput.value = '';

        fetch(`/api/fipe/${tipoVeiculo}/marcas/${marcaId}/modelos/${modeloId}/anos/`)
            .then(response => response.json())
            .then(data => {
                anoSelect.innerHTML = '<option value="" selected disabled>Selecione o ano</option>';
                data.forEach(ano => {
                    const option = new Option(ano.nome, ano.codigo);
                    anoSelect.add(option);
                });
                anoSelect.disabled = false;
            })
            .catch(error => console.error('Erro ao carregar anos:', error));
    });

    anoSelect.addEventListener('change', () => {
        const anoNome = anoSelect.options[anoSelect.selectedIndex].text;
        anoInput.value = anoNome;
    });

    document.querySelectorAll('#avaliacaoForm input, #avaliacaoForm textarea, #avaliacaoForm select').forEach(input => {
        if (input.type !== 'hidden' && input.type !== 'file') {
            input.classList.add('form-control');
        }
    });
});
</script>
{% endblock %}